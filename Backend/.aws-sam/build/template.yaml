AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "Consolidated SAM template \u2014 single CloudFront for website + all\
  \ APIs. Keep resources unchanged; single CFDistribution."
Parameters:
  FrontendDomainName:
    Type: String
    Default: containersclub.com
Globals:
  Function:
    Runtime: python3.12
    Timeout: 30
    MemorySize: 512
    Architectures:
    - arm64
Resources:
  Api:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Cors:
        AllowMethods: '''GET,POST,OPTIONS'''
        AllowHeaders: '''*'''
        AllowOrigin: '''*'''
  HttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        AllowMethods:
        - GET
        - POST
        - OPTIONS
        AllowHeaders:
        - '*'
        AllowOrigins:
        - '*'
  RentApi:
    Type: AWS::Serverless::Api
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}-RentApi
      StageName: prod
      Cors:
        AllowMethods: '''GET,POST,OPTIONS'''
        AllowHeaders: '''*'''
        AllowOrigin: '''*'''
  SellApi:
    Type: AWS::Serverless::Api
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}-SellApi
      StageName: prod
      Cors:
        AllowMethods: '''GET,POST,OPTIONS'''
        AllowHeaders: '''*'''
        AllowOrigin: '''*'''
  NewsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: ts
        AttributeType: N
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: ts
        KeyType: RANGE
      TableName:
        Fn::Sub: ${AWS::StackName}-news
  PricesOnloadTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: route
        AttributeType: S
      KeySchema:
      - AttributeName: route
        KeyType: HASH
      TableName:
        Fn::Sub: ${AWS::StackName}-prices-onload
  PricesOffloadTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: route
        AttributeType: S
      KeySchema:
      - AttributeName: route
        KeyType: HASH
      TableName:
        Fn::Sub: ${AWS::StackName}-prices-offload
  BookingsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: booking_id
        AttributeType: S
      KeySchema:
      - AttributeName: booking_id
        KeyType: HASH
      TableName:
        Fn::Sub: ${AWS::StackName}-bookings
  PortsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: country
        AttributeType: S
      - AttributeName: name
        AttributeType: S
      KeySchema:
      - AttributeName: country
        KeyType: HASH
      - AttributeName: name
        KeyType: RANGE
      TableName:
        Fn::Sub: ${AWS::StackName}-ports
  PortsTableV2:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-ports-v2
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      - AttributeName: state
        AttributeType: S
      - AttributeName: scIndexed
        AttributeType: S
      - AttributeName: city
        AttributeType: S
      - AttributeName: cityIndexed
        AttributeType: S
      - AttributeName: name_lc
        AttributeType: S
      - AttributeName: pincode
        AttributeType: S
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      GlobalSecondaryIndexes:
      - IndexName: GSI_StateCity
        KeySchema:
        - AttributeName: state
          KeyType: HASH
        - AttributeName: scIndexed
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      - IndexName: GSI_City
        KeySchema:
        - AttributeName: city
          KeyType: HASH
        - AttributeName: cityIndexed
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      - IndexName: GSI_Name
        KeySchema:
        - AttributeName: name_lc
          KeyType: HASH
        - AttributeName: id
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
      - IndexName: GSI_Pincode
        KeySchema:
        - AttributeName: pincode
          KeyType: HASH
        - AttributeName: id
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
  SubmissionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      SSESpecification:
        SSEEnabled: true
  CacheTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: container
        AttributeType: S
      KeySchema:
      - AttributeName: container
        KeyType: HASH
      SSESpecification:
        SSEEnabled: true
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: phone
        AttributeType: S
      - AttributeName: email
        AttributeType: S
      KeySchema:
      - AttributeName: phone
        KeyType: HASH
      GlobalSecondaryIndexes:
      - IndexName: EmailIndex
        KeySchema:
        - AttributeName: email
          KeyType: HASH
        Projection:
          ProjectionType: ALL
      SSESpecification:
        SSEEnabled: true
  RentListingsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: listingId
        AttributeType: S
      KeySchema:
      - AttributeName: listingId
        KeyType: HASH
      TableName:
        Fn::Sub: ${AWS::StackName}-RentListings
  SellListingsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: listingId
        AttributeType: S
      KeySchema:
      - AttributeName: listingId
        KeyType: HASH
      TableName:
        Fn::Sub: ${AWS::StackName}-SellListings
  WebBucket:
    Type: AWS::S3::Bucket
    Properties:
      OwnershipControls:
        Rules:
        - ObjectOwnership: BucketOwnerEnforced
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  RentMediaBucket:
    Type: AWS::S3::Bucket
    Properties:
      CorsConfiguration:
        CorsRules:
        - AllowedHeaders:
          - '*'
          AllowedMethods:
          - GET
          - PUT
          - HEAD
          AllowedOrigins:
          - '*'
          MaxAge: 3000
  SellMediaBucket:
    Type: AWS::S3::Bucket
    Properties:
      CorsConfiguration:
        CorsRules:
        - AllowedHeaders:
          - '*'
          AllowedMethods:
          - GET
          - PUT
          - HEAD
          AllowedOrigins:
          - '*'
          MaxAge: 3000
  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: rent-club-user-pool
      UsernameAttributes:
      - email
      AutoVerifiedAttributes:
      - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: rent-club-client
      UserPoolId:
        Ref: CognitoUserPool
      GenerateSecret: false
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthFlows:
      - implicit
      AllowedOAuthScopes:
      - email
      - openid
      ExplicitAuthFlows:
      - ALLOW_USER_SRP_AUTH
      - ALLOW_REFRESH_TOKEN_AUTH
      CallbackURLs:
      - http://localhost:3000/auth/callback
      - Fn::Sub: https://${FrontendDomainName}/rent/new.html
      LogoutURLs:
      - http://localhost:3000
      - Fn::Sub: https://${FrontendDomainName}
  CognitoDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: rent-club-auth
      UserPoolId:
        Ref: CognitoUserPool
  CognitoAdminGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: Admin
      UserPoolId:
        Ref: CognitoUserPool
  CognitoEmployeeGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: Employee
      UserPoolId:
        Ref: CognitoUserPool
  SellCognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: sell-club-user-pool
      UsernameAttributes:
      - email
      AutoVerifiedAttributes:
      - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
  SellCognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: sell-club-client
      UserPoolId:
        Ref: SellCognitoUserPool
      GenerateSecret: false
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthFlows:
      - implicit
      - code
      AllowedOAuthScopes:
      - openid
      - email
      - profile
      ExplicitAuthFlows:
      - ALLOW_USER_PASSWORD_AUTH
      - ALLOW_USER_SRP_AUTH
      - ALLOW_REFRESH_TOKEN_AUTH
      CallbackURLs:
      - http://localhost:3000/sell/new.html
      - https://containersclub.com/sell/new.html
      LogoutURLs:
      - http://localhost:3000
      - https://containersclub.com
  SellCognitoDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: sell-club-auth
      UserPoolId:
        Ref: SellCognitoUserPool
  SellCognitoAdminGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: Admin
      UserPoolId:
        Ref: SellCognitoUserPool
  SellCognitoEmployeeGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: Employee
      UserPoolId:
        Ref: SellCognitoUserPool
  SiteOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name:
          Fn::Sub: ${AWS::StackName}-oac
        Description: Access S3 bucket securely from CloudFront
        SigningBehavior: always
        SigningProtocol: sigv4
        OriginAccessControlOriginType: s3
  CFDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Origins:
        - Id: S3Origin
          DomainName:
            Fn::GetAtt:
            - WebBucket
            - RegionalDomainName
          S3OriginConfig: {}
          OriginAccessControlId:
            Fn::GetAtt:
            - SiteOAC
            - Id
        - Id: HttpApiOrigin
          DomainName:
            Fn::Sub: ${HttpApi}.execute-api.${AWS::Region}.amazonaws.com
          CustomOriginConfig:
            OriginProtocolPolicy: https-only
            OriginSSLProtocols:
            - TLSv1.2
        - Id: RestApiOrigin
          DomainName:
            Fn::Sub: ${Api}.execute-api.${AWS::Region}.amazonaws.com
          CustomOriginConfig:
            OriginProtocolPolicy: https-only
            OriginSSLProtocols:
            - TLSv1.2
        - Id: RentApiOrigin
          DomainName:
            Fn::Sub: ${RentApi}.execute-api.${AWS::Region}.amazonaws.com
          CustomOriginConfig:
            OriginProtocolPolicy: https-only
            OriginSSLProtocols:
            - TLSv1.2
        - Id: SellApiOrigin
          DomainName:
            Fn::Sub: ${SellApi}.execute-api.${AWS::Region}.amazonaws.com
          CustomOriginConfig:
            OriginProtocolPolicy: https-only
            OriginSSLProtocols:
            - TLSv1.2
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          Compress: true
          AllowedMethods:
          - GET
          - HEAD
          - OPTIONS
          CachedMethods:
          - GET
          - HEAD
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
          ResponseHeadersPolicyId: 67f7725c-6f97-4210-82d7-5512b31e9d03
        CacheBehaviors:
        - PathPattern: /api/*
          TargetOriginId: HttpApiOrigin
          ViewerProtocolPolicy: https-only
          Compress: true
          AllowedMethods:
          - GET
          - HEAD
          - OPTIONS
          - PUT
          - POST
          - PATCH
          - DELETE
          CachedMethods:
          - GET
          - HEAD
          - OPTIONS
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
          OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3
        - PathPattern: /prod/*
          TargetOriginId: RestApiOrigin
          ViewerProtocolPolicy: https-only
          AllowedMethods:
          - GET
          - HEAD
          - OPTIONS
          - PUT
          - POST
          - PATCH
          - DELETE
          CachedMethods:
          - GET
          - HEAD
          - OPTIONS
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
          OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3
        - PathPattern: /rent/api/*
          TargetOriginId: RentApiOrigin
          ViewerProtocolPolicy: https-only
          AllowedMethods:
          - GET
          - HEAD
          - OPTIONS
          - PUT
          - POST
          - PATCH
          - DELETE
          CachedMethods:
          - GET
          - HEAD
          - OPTIONS
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
          OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3
        - PathPattern: /sell/api/*
          TargetOriginId: SellApiOrigin
          ViewerProtocolPolicy: https-only
          AllowedMethods:
          - GET
          - HEAD
          - OPTIONS
          - PUT
          - POST
          - PATCH
          - DELETE
          CachedMethods:
          - GET
          - HEAD
          - OPTIONS
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
          OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3
        PriceClass: PriceClass_100
  WebBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: WebBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: AllowCloudFrontServiceGet
          Effect: Allow
          Principal:
            Service: cloudfront.amazonaws.com
          Action: s3:GetObject
          Resource:
            Fn::Sub: ${WebBucket.Arn}/*
          Condition:
            StringEquals:
              AWS:SourceArn:
                Fn::Sub: arn:aws:cloudfront::${AWS::AccountId}:distribution/${CFDistribution}
  NewsFetcherFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      CodeUri: NewsFetcherFunction
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: NewsTable
      Environment:
        Variables:
          NEWS_TABLE:
            Ref: NewsTable
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: rate(1 day)
    Metadata:
      SamResourceId: NewsFetcherFunction
  GetNewsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      CodeUri: GetNewsFunction
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: NewsTable
      Environment:
        Variables:
          NEWS_TABLE:
            Ref: NewsTable
      Events:
        ApiGet:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /news
            Method: GET
    Metadata:
      SamResourceId: GetNewsFunction
  PriceLookupFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      CodeUri: PriceLookupFunction
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: PricesOnloadTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: PricesOffloadTable
      Environment:
        Variables:
          ONLOAD_TABLE:
            Ref: PricesOnloadTable
          OFFLOAD_TABLE:
            Ref: PricesOffloadTable
      Events:
        ApiPost:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /prices
            Method: POST
    Metadata:
      SamResourceId: PriceLookupFunction
  BookingFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      CodeUri: BookingFunction
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: BookingsTable
      Environment:
        Variables:
          BOOKINGS_TABLE:
            Ref: BookingsTable
      Events:
        ApiPost:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /book
            Method: POST
    Metadata:
      SamResourceId: BookingFunction
  PortsSearchFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      CodeUri: PortsSearchFunction
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: PortsTableV2
      - Statement:
        - Effect: Allow
          Action:
          - dynamodb:Query
          - dynamodb:Scan
          - dynamodb:GetItem
          Resource:
          - Fn::GetAtt:
            - PortsTableV2
            - Arn
          - Fn::Sub: ${PortsTableV2.Arn}/index/*
      Environment:
        Variables:
          PORTS_TABLE:
            Ref: PortsTableV2
      Events:
        ApiList:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /ports
            Method: GET
        ApiDetail:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /ports/{id}
            Method: GET
        ApiFilters:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /ports/filters
            Method: GET
    Metadata:
      SamResourceId: PortsSearchFunction
  ListCreateListingFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      CodeUri: ListCreateListingFunction
      Policies:
      - DynamoDBWritePolicy:
          TableName:
            Ref: RentListingsTable
      Environment:
        Variables:
          TABLE_NAME:
            Ref: RentListingsTable
      Events:
        ApiPost:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /listings
            Method: POST
    Metadata:
      SamResourceId: ListCreateListingFunction
  ListListListingFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      CodeUri: ListListListingFunction
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: RentListingsTable
      Environment:
        Variables:
          TABLE_NAME:
            Ref: RentListingsTable
      Events:
        ApiGet:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /listings
            Method: GET
    Metadata:
      SamResourceId: ListListListingFunction
  ListListingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ListListingsFunction
      Handler: app.handler
      Runtime: python3.12
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: RentListingsTable
      Environment:
        Variables:
          TABLE_NAME:
            Ref: RentListingsTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /rent/listings
            Method: GET
            RestApiId:
              Ref: RentApi
    Metadata:
      SamResourceId: ListListingsFunction
  CreateListingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CreateListingFunction
      Handler: app.handler
      Runtime: python3.12
      Policies:
      - DynamoDBWritePolicy:
          TableName:
            Ref: RentListingsTable
      Environment:
        Variables:
          TABLE_NAME:
            Ref: RentListingsTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /rent/listings
            Method: POST
            RestApiId:
              Ref: RentApi
    Metadata:
      SamResourceId: CreateListingFunction
  PresignUploadFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: PresignUploadFunction
      Handler: app.handler
      Runtime: python3.12
      Policies:
      - S3CrudPolicy:
          BucketName:
            Ref: RentMediaBucket
      Environment:
        Variables:
          BUCKET_NAME:
            Ref: RentMediaBucket
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /rent/presign
            Method: POST
            RestApiId:
              Ref: RentApi
    Metadata:
      SamResourceId: PresignUploadFunction
  SellListListingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SellListListingsFunction
      Handler: app.handler
      Runtime: python3.12
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: SellListingsTable
      Environment:
        Variables:
          TABLE_NAME:
            Ref: SellListingsTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /sell/listings
            Method: GET
            RestApiId:
              Ref: SellApi
    Metadata:
      SamResourceId: SellListListingsFunction
  SellCreateListingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SellCreateListingFunction
      Handler: app.handler
      Runtime: python3.12
      Policies:
      - DynamoDBWritePolicy:
          TableName:
            Ref: SellListingsTable
      Environment:
        Variables:
          TABLE_NAME:
            Ref: SellListingsTable
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /sell/listings
            Method: POST
            RestApiId:
              Ref: SellApi
    Metadata:
      SamResourceId: SellCreateListingFunction
  SellPresignUploadFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SellPresignUploadFunction
      Handler: app.handler
      Runtime: python3.12
      Policies:
      - S3CrudPolicy:
          BucketName:
            Ref: SellMediaBucket
      Environment:
        Variables:
          BUCKET_NAME:
            Ref: SellMediaBucket
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /sell/presign
            Method: POST
            RestApiId:
              Ref: SellApi
    Metadata:
      SamResourceId: SellPresignUploadFunction
  ApiFunc:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ApiFunc
      Handler: index.handler
      Runtime: nodejs20.x
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: SubmissionsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: CacheTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      Environment:
        Variables:
          SUBMISSION_TABLE:
            Ref: SubmissionsTable
          CACHE_TABLE:
            Ref: CacheTable
          USERS_TABLE:
            Ref: UsersTable
      Events:
        GetCarriers:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Path: /api/carriers
            Method: GET
        Resolve:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Path: /api/resolve
            Method: POST
        InitTrack:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Path: /api/track/init
            Method: POST
        TrackDetails:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Path: /api/track/details
            Method: POST
    Metadata:
      SamResourceId: ApiFunc
  TrackFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: TrackFunction
      Handler: index.handler
      Runtime: nodejs20.x
      Environment:
        Variables: {}
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /track
            Method: GET
            RestApiId:
              Ref: Api
    Metadata:
      SamResourceId: TrackFunction
  ContactFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      CodeUri: ContactFunction
      Policies: []
      Environment:
        Variables: {}
    Metadata:
      SamResourceId: ContactFunction
  BookFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      CodeUri: BookFunction
      Policies: []
      Environment:
        Variables: {}
    Metadata:
      SamResourceId: BookFunction
  PortFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      CodeUri: PortFunction
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: PortsTableV2
      Environment:
        Variables:
          PORTS_TABLE:
            Ref: PortsTableV2
    Metadata:
      SamResourceId: PortFunction
  PriceFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: app.lambda_handler
      CodeUri: PriceFunction
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: PricesOnloadTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: PricesOffloadTable
      Environment:
        Variables:
          ONLOAD_TABLE:
            Ref: PricesOnloadTable
          OFFLOAD_TABLE:
            Ref: PricesOffloadTable
    Metadata:
      SamResourceId: PriceFunction
  BlogTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      TableName:
        Fn::Sub: ${AWS::StackName}-blog
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      - AttributeName: ts
        AttributeType: N
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      - AttributeName: ts
        KeyType: RANGE
  BlogMediaBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: ${AWS::StackName}-blog-media
      CorsConfiguration:
        CorsRules:
        - AllowedHeaders:
          - '*'
          AllowedMethods:
          - GET
          - PUT
          - HEAD
          AllowedOrigins:
          - '*'
          MaxAge: 3000
  BlogCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: BlogCreateFunction
      Handler: app.handler
      Runtime: python3.12
      Timeout: 30
      MemorySize: 512
      Policies:
      - DynamoDBWritePolicy:
          TableName:
            Ref: BlogTable
      Environment:
        Variables:
          BLOG_TABLE:
            Ref: BlogTable
      Events:
        ApiCreate:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /blog/create
            Method: POST
    Metadata:
      SamResourceId: BlogCreateFunction
  BlogGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: BlogGetFunction
      Handler: app.handler
      Runtime: python3.12
      Timeout: 30
      MemorySize: 512
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: BlogTable
      Environment:
        Variables:
          BLOG_TABLE:
            Ref: BlogTable
      Events:
        ApiGetBlog:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /blog/get
            Method: GET
    Metadata:
      SamResourceId: BlogGetFunction
  BlogListFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: BlogListFunction
      Handler: app.handler
      Runtime: python3.12
      Timeout: 30
      MemorySize: 512
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: BlogTable
      Environment:
        Variables:
          BLOG_TABLE:
            Ref: BlogTable
      Events:
        ApiListBlogs:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /blog/list
            Method: GET
    Metadata:
      SamResourceId: BlogListFunction
  BlogUpdateFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: BlogUpdateFunction
      Handler: app.handler
      Runtime: python3.12
      Timeout: 30
      MemorySize: 512
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: BlogTable
      Environment:
        Variables:
          BLOG_TABLE:
            Ref: BlogTable
      Events:
        ApiUpdateBlog:
          Type: Api
          Properties:
            RestApiId:
              Ref: Api
            Path: /blog/update
            Method: PUT
    Metadata:
      SamResourceId: BlogUpdateFunction
Outputs:
  CloudFrontURL:
    Description: CloudFront distribution domain
    Value:
      Fn::Sub: https://${CFDistribution.DomainName}
  WebBucketName:
    Description: Website S3 bucket
    Value:
      Ref: WebBucket
  ApiInvokeURLHttpApi:
    Description: HttpApi invoke URL
    Value:
      Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com
  ApiInvokeURLRestApi:
    Description: Rest Api invoke URL (prod stage)
    Value:
      Fn::Sub: https://${Api}.execute-api.${AWS::Region}.amazonaws.com/prod
  NewsTableName:
    Value:
      Ref: NewsTable
  OnloadTableName:
    Value:
      Ref: PricesOnloadTable
  OffloadTableName:
    Value:
      Ref: PricesOffloadTable
  BookingsTableName:
    Value:
      Ref: BookingsTable
  PortsTableName:
    Value:
      Ref: PortsTableV2
  LegacyPortsTableName:
    Value:
      Ref: PortsTable
  UsersTableName:
    Value:
      Ref: UsersTable
